<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HVAC Panel (MQTT)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 18px; background:#f1f1f1; }
    .wrap { max-width: 980px; }
    .top { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .card { padding: 14px; border: 2px solid #6b8e23; border-radius: 12px; background:#e6e6e6; }
    .row { display:flex; justify-content:space-between; align-items:center; gap:10px; padding:6px 0; }
    .val { font-weight: 800; }
    .muted { color:#555; font-size: .92rem; margin-top: 6px; }
    input { padding: 8px; border: 1px solid #bbb; border-radius: 10px; width: 140px; background:#fafafa; }
    button { padding: 10px 12px; border: 1px solid #bbb; border-radius: 10px; background: #f7f7f7; cursor: pointer; }
    button:active { transform: translateY(1px); }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .btnrow { display:flex; flex-wrap: wrap; gap: 10px; align-items:center; }
    .btn-green { background: #dcfce7; border-color:#86efac; }
    .btn-red   { background: #fee2e2; border-color:#fca5a5; }
    .btn-blue  { background: #dbeafe; border-color:#93c5fd; }
    .btn-gray  { background: #f3f4f6; border-color:#d1d5db; }

    .hide { display:none !important; }

    /* Login */
    .login-wrap { max-width: 420px; margin: 10vh auto 0 auto; }
    .login-card { padding: 18px; border: 2px solid #6b8e23; border-radius: 12px; background:#e6e6e6; }
    .login-row { display:flex; flex-direction:column; gap:10px; margin-top: 12px; }
    .login-row label { font-size: .95rem; color:#222; }
    .login-row input { width: 100%; }
    .login-actions { display:flex; gap:10px; margin-top: 14px; align-items:center; justify-content:flex-end; }
    .login-err { color:#b00020; font-size:.95rem; margin-top:10px; min-height: 1.2em; }

    @media (max-width: 900px){
      .top { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

<!-- ===== LOGIN ===== -->
<div id="loginScreen" class="login-wrap">
  <div class="login-card">
    <h2>üîí Giri≈ü</h2>
    <div class="muted">Kullanƒ±cƒ± adƒ± ve ≈üifreyi girin.</div>

    <div class="login-row">
      <label>Kullanƒ±cƒ± adƒ±</label>
      <input id="u" autocomplete="username" />
      <label>≈ûifre</label>
      <input id="p" type="password" autocomplete="current-password" />
    </div>

    <div class="login-actions">
      <button id="loginBtn" class="btn-green">Giri≈ü</button>
    </div>

    <div id="loginErr" class="login-err"></div>
  </div>
</div>

<!-- ===== PANEL ===== -->
<div id="panelScreen" class="wrap hide">
  <div class="top">
    <div class="card">
      <div class="row" style="align-items:flex-start;">
        <h2 style="margin:0;">üì° √ñl√ß√ºmler</h2>
        <div style="display:flex; gap:10px; align-items:center;">
          <button id="minmaxResetBtn" class="btn-gray">Min/Max Sƒ±fƒ±rla</button>
          <button id="logoutBtn" class="btn-red">√áƒ±kƒ±≈ü</button>
        </div>
      </div>

      <div class="row"><div>Durum</div><div class="val" id="conn">Baƒülanƒ±yor‚Ä¶</div></div>
      <div class="row"><div>Sƒ±caklƒ±k</div><div class="val" id="t">--</div></div>
      <div class="row"><div>Nem</div><div class="val" id="h">--</div></div>
      <div class="row"><div>Min/Max (T)</div><div class="val" id="tmm">--</div></div>
      <div class="row"><div>Min/Max (H)</div><div class="val" id="hmm">--</div></div>

      <!-- ƒ∞stediƒüin: √∂rnekleme zamanƒ± deƒüil NORMAL saat -->
      <div class="muted" id="clock">Saat: --</div>

      <div class="muted" id="ntp">NTP: --</div>
      <div class="muted" id="err" style="color:#8a5a00;"></div>
    </div>

    <div class="card">
      <h2>üéõÔ∏è Kontrol</h2>
      <div class="row"><div>Mod</div><div class="val" id="modeTxt">--</div></div>
      <div class="row"><div>Kombi</div><div class="val" id="kombiTxt">--</div></div>
      <div class="row"><div>Klima</div><div class="val" id="klimaTxt">--</div></div>

      <div class="row">
        <div>Ayarlar</div>
        <div class="btnrow">
          <label>SP (¬∞C) <input id="sp" type="number" step="0.1" min="10" max="35"/></label>
          <label>Hys (¬∞C) <input id="hys" type="number" step="0.1" min="0.5" max="3.0"/></label>
          <button id="logicBtn" class="btn-blue">AC</button>
          <button id="saveBtn">Kaydet</button>
        </div>
      </div>

      <div class="btnrow" style="margin-top:8px;">
        <button id="modeBtn">AUTO</button>
        <button id="kombiBtn">KOMBI</button>
        <button id="klimaBtn">KLIMA</button>
      </div>

      <div class="muted">
        Not: MANUAL modda Kombi/Klima ayrƒ± ayrƒ± a√ßƒ±lƒ±r. AUTO modda logic‚Äôe g√∂re sadece biri √ßalƒ±≈üƒ±r.
      </div>
    </div>
  </div>
</div>

<!-- mqtt.js -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>
/* =========================
   1) AYARLAR
   ========================= */
const LOGIN_USER = "admin";   // istediƒüin kullanƒ±cƒ± adƒ±
const LOGIN_PASS = "1234";    // istediƒüin ≈üifre

// Broker (EMQX public WSS)
const BROKER_WSS = "wss://broker.emqx.io:8084/mqtt";
// HiveMQ public istersen:
// const BROKER_WSS = "wss://broker.hivemq.com:8884/mqtt";

const BASE_TOPIC = "omer/hvac/9f3a1c7b2d4e6f8a";
const CMD_KEY    = "K!n@l1_2026_x9Qp7v";

const T_TELE  = `${BASE_TOPIC}/tele`;
const T_STATE = `${BASE_TOPIC}/state`;
const T_CMD   = `${BASE_TOPIC}/cmd`;
const T_LWT   = `${BASE_TOPIC}/lwt`;

/* =========================
   2) DOM
   ========================= */
const loginScreen = document.getElementById("loginScreen");
const panelScreen = document.getElementById("panelScreen");

const elU = document.getElementById("u");
const elP = document.getElementById("p");
const elLoginBtn = document.getElementById("loginBtn");
const elLoginErr = document.getElementById("loginErr");

const elLogoutBtn = document.getElementById("logoutBtn");
const elResetMM = document.getElementById("minmaxResetBtn");

const elConn = document.getElementById("conn");
const elT = document.getElementById("t");
const elH = document.getElementById("h");
const elTMM = document.getElementById("tmm");
const elHMM = document.getElementById("hmm");
const elClock = document.getElementById("clock");
const elNTP = document.getElementById("ntp");
const elErr = document.getElementById("err");

const elModeTxt = document.getElementById("modeTxt");
const elKombiTxt = document.getElementById("kombiTxt");
const elKlimaTxt = document.getElementById("klimaTxt");

const elSP = document.getElementById("sp");
const elHys = document.getElementById("hys");
const elLogicBtn = document.getElementById("logicBtn");
const elSaveBtn = document.getElementById("saveBtn");
const elModeBtn = document.getElementById("modeBtn");
const elKombiBtn = document.getElementById("kombiBtn");
const elKlimaBtn = document.getElementById("klimaBtn");

/* =========================
   3) PANEL STATE
   ========================= */
let state = {
  mode: null, logic: "AC",
  sp: 25.0, hys: 1.0,
  kombi: 0, klima: 0,
  ntp_ok: 0
};

let minT=null, maxT=null, minH=null, maxH=null;
let dirtySP=false, dirtyHys=false, debounceT=null;

/* =========================
   4) NORMAL SAAT (TARAYICI)
   ========================= */
function pad2(n){ return (n<10 ? "0"+n : ""+n); }
function fmtLocalNow(){
  const d = new Date();
  return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ` +
         `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
}
setInterval(()=>{ elClock.textContent = "Saat: " + fmtLocalNow(); }, 1000);

/* =========================
   5) MIN/MAX
   ========================= */
function updateMinMax(t, h){
  if (t != null && Number.isFinite(t)){
    minT = (minT==null) ? t : Math.min(minT, t);
    maxT = (maxT==null) ? t : Math.max(maxT, t);
  }
  if (h != null && Number.isFinite(h)){
    minH = (minH==null) ? h : Math.min(minH, h);
    maxH = (maxH==null) ? h : Math.max(maxH, h);
  }
  elTMM.textContent = (minT==null||maxT==null) ? "--" : `${minT.toFixed(1)} / ${maxT.toFixed(1)} ¬∞C`;
  elHMM.textContent = (minH==null||maxH==null) ? "--" : `${minH.toFixed(1)} / ${maxH.toFixed(1)} %`;
}

/* =========================
   6) UI BUTON STƒ∞LLERƒ∞
   ========================= */
function styleButtons(){
  if (state.mode === "AUTO"){
    elModeBtn.className = "btn-green";
    elModeBtn.textContent = "AUTO";
  } else if (state.mode === "MANUAL"){
    elModeBtn.className = "btn-red";
    elModeBtn.textContent = "MANUAL";
  } else {
    elModeBtn.className = "btn-gray";
    elModeBtn.textContent = "AUTO";
  }
  elModeTxt.textContent = state.mode || "--";

  if (state.logic === "AC"){
    elLogicBtn.className = "btn-blue";
    elLogicBtn.textContent = "AC";
  } else {
    elLogicBtn.className = "btn-red";
    elLogicBtn.textContent = "HEAT";
  }

  elKombiTxt.textContent = state.kombi ? "ON" : "OFF";
  elKlimaTxt.textContent = state.klima ? "ON" : "OFF";

  const manual = (state.mode === "MANUAL");
  elKombiBtn.disabled = !manual;
  elKlimaBtn.disabled = !manual;

  elKombiBtn.className = manual ? (state.kombi ? "btn-green":"btn-gray") : "btn-gray";
  elKlimaBtn.className = manual ? (state.klima ? "btn-green":"btn-gray") : "btn-gray";

  elKombiBtn.textContent = manual ? (state.kombi ? "KOMBI ON":"KOMBI OFF") : "KOMBI";
  elKlimaBtn.textContent = manual ? (state.klima ? "KLIMA ON":"KLIMA OFF") : "KLIMA";
}

/* =========================
   7) MQTT (HATA FIX: client √∂nce declare)
   ========================= */
let client = null;        // <-- fix burada
let mqttStarted = false;

function publishCmd(obj){
  if (!client || !client.connected) return;
  obj.key = CMD_KEY;
  client.publish(T_CMD, JSON.stringify(obj), {qos:0, retain:false});
}

function mqttStart(){
  if (mqttStarted) return;
  mqttStarted = true;

  const clientId = "web_" + Math.random().toString(16).slice(2);
  client = mqtt.connect(BROKER_WSS, {
    clientId,
    clean: true,
    reconnectPeriod: 2000,
    connectTimeout: 8000,
    protocolVersion: 4
  });

  client.on("connect", ()=>{
    elConn.textContent = "BAƒûLANDI";
    elConn.style.color = "#0a7a2f";
    elErr.textContent = "";
    client.subscribe([T_TELE, T_STATE, T_LWT], {qos:0});
  });

  client.on("reconnect", ()=>{
    elConn.textContent = "Baƒülanƒ±yor‚Ä¶";
    elConn.style.color = "#333";
  });

  client.on("offline", ()=>{
    elConn.textContent = "KAPALI";
    elConn.style.color = "#b00020";
  });

  client.on("error", (e)=>{
    elErr.textContent = "MQTT hata: " + (e?.message || e);
  });

  client.on("message", (topic, payload)=>{
    let j=null;
    try { j = JSON.parse(payload.toString()); } catch(e){ return; }
    if (!j) return;

    if (topic === T_TELE){
      const t = (j.t == null) ? null : Number(j.t);
      const h = (j.h == null) ? null : Number(j.h);

      elT.textContent = (t==null || !Number.isFinite(t)) ? "--" : t.toFixed(1) + " ¬∞C";
      elH.textContent = (h==null || !Number.isFinite(h)) ? "--" : h.toFixed(1) + " %";
      updateMinMax(t, h);

      elNTP.textContent = "NTP: " + (j.ntp_ok ? "OK" : "BEKLENƒ∞YOR");

      if (j.mode) state.mode = j.mode;
      if (j.logic) state.logic = j.logic;
      if (j.sp != null) state.sp = Number(j.sp);
      if (j.hys != null) state.hys = Number(j.hys);
      if (j.kombi != null) state.kombi = Number(j.kombi);
      if (j.klima != null) state.klima = Number(j.klima);

      if (!dirtySP && document.activeElement !== elSP) elSP.value = state.sp.toFixed(1);
      if (!dirtyHys && document.activeElement !== elHys) elHys.value = state.hys.toFixed(1);
      styleButtons();
    }

    if (topic === T_STATE){
      if (j.mode) state.mode = j.mode;
      if (j.logic) state.logic = j.logic;
      if (j.sp != null) state.sp = Number(j.sp);
      if (j.hys != null) state.hys = Number(j.hys);

      if (j.kombi) state.kombi = (j.kombi === "ON") ? 1 : 0;
      if (j.klima) state.klima = (j.klima === "ON") ? 1 : 0;

      if (!dirtySP && document.activeElement !== elSP) elSP.value = state.sp.toFixed(1);
      if (!dirtyHys && document.activeElement !== elHys) elHys.value = state.hys.toFixed(1);
      styleButtons();
    }
  });
}

function mqttStop(){
  mqttStarted = false;
  try { if (client) client.end(true); } catch(e){}
  client = null;
  elConn.textContent = "KAPALI";
  elConn.style.color = "#b00020";
}

/* =========================
   8) PANEL EVENTLERƒ∞
   ========================= */
function scheduleAutoSave(){
  if (debounceT) clearTimeout(debounceT);
  debounceT = setTimeout(()=>{
    const sp = parseFloat(elSP.value);
    const hys = parseFloat(elHys.value);
    if (Number.isNaN(sp) || Number.isNaN(hys)) return;
    publishCmd({ sp, hys });
    dirtySP=false; dirtyHys=false;
  }, 1500);
}

elSP.addEventListener("input", ()=>{ dirtySP=true; scheduleAutoSave(); });
elHys.addEventListener("input", ()=>{ dirtyHys=true; scheduleAutoSave(); });

elSaveBtn.addEventListener("click", ()=>{
  const sp = parseFloat(elSP.value);
  const hys = parseFloat(elHys.value);
  if (Number.isNaN(sp) || Number.isNaN(hys)) return;
  publishCmd({ sp, hys });
  dirtySP=false; dirtyHys=false;
});

elModeBtn.addEventListener("click", ()=>{
  const next = (state.mode === "AUTO") ? "MANUAL" : "AUTO";
  publishCmd({ mode: next });
});

elLogicBtn.addEventListener("click", ()=>{
  const next = (state.logic === "AC") ? "HEAT" : "AC";
  publishCmd({ logic: next });
});

elKombiBtn.addEventListener("click", ()=>{
  const next = state.kombi ? "OFF" : "ON";
  publishCmd({ kombi: next });
});

elKlimaBtn.addEventListener("click", ()=>{
  const next = state.klima ? "OFF" : "ON";
  publishCmd({ klima: next });
});

elResetMM.addEventListener("click", ()=>{
  minT=maxT=minH=maxH=null;
  updateMinMax(null, null);
});

/* =========================
   9) LOGIN AKI≈ûI
   ========================= */
function showPanel(){
  loginScreen.classList.add("hide");
  panelScreen.classList.remove("hide");
  mqttStart(); // login sonrasƒ± kesin ba≈ülat
}

function showLogin(){
  panelScreen.classList.add("hide");
  loginScreen.classList.remove("hide");
}

function tryLogin(){
  const u = (elU.value||"").trim();
  const p = (elP.value||"").trim();

  if (u === LOGIN_USER && p === LOGIN_PASS){
    elLoginErr.textContent = "";
    sessionStorage.setItem("hvac_auth","1");
    showPanel();
  } else {
    elLoginErr.textContent = "Hatalƒ± kullanƒ±cƒ± adƒ± veya ≈üifre.";
  }
}

elLoginBtn.addEventListener("click", tryLogin);
elP.addEventListener("keydown", (e)=>{ if (e.key==="Enter") tryLogin(); });
elU.addEventListener("keydown", (e)=>{ if (e.key==="Enter") tryLogin(); });

elLogoutBtn.addEventListener("click", ()=>{
  sessionStorage.removeItem("hvac_auth");
  mqttStop();
  showLogin();
});

/* Sayfa a√ßƒ±lƒ±nca */
if (sessionStorage.getItem("hvac_auth")==="1") showPanel();
else showLogin();
</script>
</body>
</html>
