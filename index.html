<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HVAC Panel (MQTT)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 18px; background:#f1f1f1; }
    .wrap { max-width: 980px; }
    .top { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .card { padding: 14px; border: 2px solid #6b8e23; border-radius: 12px; background:#e6e6e6; }
    .row { display:flex; justify-content:space-between; align-items:center; gap:10px; padding:6px 0; }
    .val { font-weight: 800; }
    .muted { color:#555; font-size: .92rem; margin-top: 6px; }
    input { padding: 10px; border: 1px solid #bbb; border-radius: 10px; width: 170px; background:#fafafa; }
    button { padding: 10px 12px; border: 1px solid #bbb; border-radius: 10px; background: #f7f7f7; cursor: pointer; }
    button:active { transform: translateY(1px); }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .btnrow { display:flex; flex-wrap: wrap; gap: 10px; align-items:center; }
    .btn-green { background: #dcfce7; border-color:#86efac; }
    .btn-red   { background: #fee2e2; border-color:#fca5a5; }
    .btn-blue  { background: #dbeafe; border-color:#93c5fd; }
    .btn-gray  { background: #f3f4f6; border-color:#d1d5db; }

    .hidden { display:none !important; }

    /* Login */
    .loginWrap { max-width: 420px; margin: 60px auto; }
    .loginCard { padding: 18px; border: 2px solid #6b8e23; border-radius: 12px; background:#e6e6e6; }
    .loginCard h2 { margin: 0 0 12px 0; }
    .loginCard .row { justify-content:flex-start; gap:12px; }
    .loginCard label { width: 110px; }
    .loginErr { color:#b00020; font-weight:700; margin-top:10px; min-height: 22px; }

    /* Status coloring */
    .st-online  { color:#0a7a2f; font-weight: 900; }
    .st-offline { color:#b00020; font-weight: 900; }
    .st-on      { color:#0a7a2f; font-weight: 900; }
    .st-off     { color:#b00020; font-weight: 900; }
    .st-unk     { color:#555; font-weight: 900; }
    .st-pend    { color:#1d4ed8; font-weight: 900; } /* pending */

    @media (max-width: 900px){
      .top { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- LOGIN EKRANI -->
<div id="loginView" class="loginWrap">
  <div class="loginCard">
    <h2>ğŸ”’ GiriÅŸ</h2>
    <div class="row"><label>KullanÄ±cÄ±</label><input id="loginUser" autocomplete="username"></div>
    <div class="row"><label>Åifre</label><input id="loginPass" type="password" autocomplete="current-password"></div>
    <div class="btnrow" style="margin-top:12px;">
      <button id="loginBtn" class="btn-green">GiriÅŸ Yap</button>
      <button id="loginClearBtn">Temizle</button>
    </div>
    <div class="muted">Not: Bu giriÅŸ ekranÄ± ÅŸimdilik â€œkapÄ±â€ amaÃ§lÄ±dÄ±r (client-side).</div>
    <div id="loginErr" class="loginErr"></div>
  </div>
</div>

<!-- PANEL -->
<div id="panelView" class="wrap hidden">
  <div class="top">

    <div class="card">
      <div class="btnrow" style="justify-content:space-between;">
        <h2 style="margin:0;">ğŸ“¡ Ã–lÃ§Ã¼mler</h2>
        <div class="btnrow">
          <button id="minmaxBtn">Min/Max SÄ±fÄ±rla</button>
          <button id="logoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
      </div>

      <div class="row"><div>Durum</div><div class="val" id="conn">BaÄŸlanÄ±yorâ€¦</div></div>
      <div class="row"><div>Ana NodeMCU</div><div class="val" id="mainDev">--</div></div>

      <div class="row"><div>SÄ±caklÄ±k</div><div class="val" id="t">--</div></div>
      <div class="row"><div>Nem</div><div class="val" id="h">--</div></div>

      <div class="row"><div>Min/Max (T)</div><div class="val" id="tmm">--</div></div>
      <div class="row"><div>Min/Max (H)</div><div class="val" id="hmm">--</div></div>

      <div class="muted" id="clock">Saat: --</div>
      <div class="muted" id="lastSample">Son okuma: --</div>
      <div class="muted" id="ntp">NTP: --</div>
      <div class="muted" id="err" style="color:#8a5a00;"></div>
    </div>

    <div class="card">
      <h2>ğŸ›ï¸ Kontrol</h2>
      <div class="row"><div>Mod</div><div class="val" id="modeTxt">--</div></div>

      <div class="row"><div>Kombi</div><div class="val" id="kombiTxt">--</div></div>
      <div class="row"><div>Klima</div><div class="val" id="klimaTxt">--</div></div>

      <div class="row">
        <div>Ayarlar</div>
        <div class="btnrow">
          <label>SP (Â°C) <input id="sp" type="number" step="0.1" min="10" max="35"/></label>
          <label>Hys (Â°C) <input id="hys" type="number" step="0.1" min="0.5" max="3.0"/></label>
          <button id="logicBtn" class="btn-blue">AC</button>
          <button id="saveBtn">Kaydet</button>
        </div>
      </div>

      <div class="btnrow" style="margin-top:8px;">
        <button id="modeBtn">AUTO</button>
        <button id="kombiBtn">KOMBI</button>
        <button id="klimaBtn">KLIMA</button>
      </div>

      <div class="muted" id="hint">
        Not: MANUAL modda Kombi/Klima ayrÄ± ayrÄ± aÃ§Ä±lÄ±r. AUTO modda logicâ€™e gÃ¶re sadece biri Ã§alÄ±ÅŸÄ±r.
        <br/>Not2: OFFLINE durumda butonlar komut kabul etmez.
      </div>
    </div>

  </div>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
/* ===================== AYARLAR ===================== */
const BROKER_WSS = "wss://broker.emqx.io:8084/mqtt";
const BASE_TOPIC = "omer/hvac/9f3a1c7b2d4e6f8a";
const CMD_KEY    = "K!n@l1_2026_x9Qp7v";

const T_TELE  = `${BASE_TOPIC}/tele`;
const T_STATE = `${BASE_TOPIC}/state`;
const T_CMD   = `${BASE_TOPIC}/cmd`;
const T_LWT   = `${BASE_TOPIC}/lwt`;

/*
  Ana NodeMCUâ€™nun fiÅŸi Ã§ekildiÄŸinde brokerâ€™Ä±n "offline" yazmasÄ±
  keepalive timeout ile olur. Daha hÄ±zlÄ± ve deterministik olmasÄ± iÃ§in
  panel ayrÄ±ca â€œheartbeat TTLâ€ uygular:

  - Ana NodeMCUâ€™dan TELE/STATE gelmezse X ms sonra OFFLINE kabul eder.
  - TELE/STATE periyodu 10s olduÄŸundan TTL ~20s uygundur.
*/
const MAIN_TTL_MS = 2000;

/* â€œkapÄ±â€ login (client-side) */
const LOGIN_USER = "omer";
const LOGIN_PASS = "1234";

/* ===================== DOM ===================== */
const loginView = document.getElementById("loginView");
const panelView = document.getElementById("panelView");
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const loginBtn  = document.getElementById("loginBtn");
const loginClearBtn = document.getElementById("loginClearBtn");
const loginErr  = document.getElementById("loginErr");

const elConn = document.getElementById("conn");
const elMainDev = document.getElementById("mainDev");

const elT = document.getElementById("t");
const elH = document.getElementById("h");
const elTmm = document.getElementById("tmm");
const elHmm = document.getElementById("hmm");
const elClock = document.getElementById("clock");
const elLastSample = document.getElementById("lastSample");
const elNTP = document.getElementById("ntp");
const elErr = document.getElementById("err");

const elModeTxt = document.getElementById("modeTxt");
const elKombiTxt = document.getElementById("kombiTxt");
const elKlimaTxt = document.getElementById("klimaTxt");

const elSP = document.getElementById("sp");
const elHys = document.getElementById("hys");
const elLogicBtn = document.getElementById("logicBtn");
const elSaveBtn = document.getElementById("saveBtn");

const elModeBtn = document.getElementById("modeBtn");
const elKombiBtn = document.getElementById("kombiBtn");
const elKlimaBtn = document.getElementById("klimaBtn");

const logoutBtn = document.getElementById("logoutBtn");
const minmaxBtn = document.getElementById("minmaxBtn");

/* ===================== STATE ===================== */
let state = {
  mode: null, logic: "AC",
  sp: 25.0, hys: 1.0,

  // Commanded (panel -> main -> actuator cmd)
  kombi_cmd: 0,
  klima_cmd: 0,

  // Actuator feedback / online flags (reported by MAIN)
  kombi_online: 0,
  klima_online: 0,
  kombi_act: -1,   // -1 unknown, 0 OFF, 1 ON
  klima_act: -1,

  // main device online flag
  main_online: null
};

let lastSeenMainMs = 0;

let dirtySP=false, dirtyHys=false;
let debounceT=null;
let client = null;

/* ===================== ZAMAN ===================== */
function pad2(n){ return (n<10 ? "0"+n : ""+n); }
function fmtLocalNow(){
  const d = new Date();
  return pad2(d.getDate())+"/"+pad2(d.getMonth()+1)+"/"+d.getFullYear()+" "+
         pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds());
}
setInterval(()=>{ elClock.textContent = "Saat: " + fmtLocalNow(); }, 1000);

function fmtTRT(epochUtc, tzOffS){
  const dt = new Date((epochUtc + tzOffS) * 1000);
  return pad2(dt.getUTCDate())+"/"+pad2(dt.getUTCMonth()+1)+"/"+dt.getUTCFullYear()+" "+
         pad2(dt.getUTCHours())+":"+pad2(dt.getUTCMinutes())+":"+pad2(dt.getUTCSeconds());
}

function clampInt(v, defVal){
  const n = Number(v);
  return Number.isFinite(n) ? n : defVal;
}

/* ===================== RENDER HELPERS ===================== */
function renderActStatus(online, act){
  const isOnline = !!online;
  if (!isOnline) return `<span class="st-offline">Offline</span>`;
  const onlineSpan = `<span class="st-online">Online</span>`;
  if (act === 1) return `${onlineSpan}-<span class="st-on">ON</span>`;
  if (act === 0) return `${onlineSpan}-<span class="st-off">OFF</span>`;
  return `${onlineSpan}-<span class="st-unk">?</span>`;
}

function renderMainStatus(v){
  if (v === 1) return `<span class="st-online">Online</span>`;
  if (v === 0) return `<span class="st-offline">Offline</span>`;
  return `<span class="st-unk">--</span>`;
}

function isPending(online, act, cmd){
  if (!online) return false;
  if (act === -1) return true;
  return (cmd !== act);
}

/* MAIN offline olursa aktÃ¼atÃ¶rleri de â€œkullanÄ±lamazâ€ say */
function markAllUnavailable(){
  state.kombi_online = 0;
  state.klima_online = 0;
  state.kombi_act = -1;
  state.klima_act = -1;
}

/* ===================== UI ===================== */
function styleButtons(){
  elMainDev.innerHTML = renderMainStatus(state.main_online);

  // Mode button
  if (state.mode === "AUTO"){
    elModeBtn.className = "btn-green";
    elModeBtn.textContent = "AUTO";
  } else if (state.mode === "MANUAL"){
    elModeBtn.className = "btn-red";
    elModeBtn.textContent = "MANUAL";
  } else {
    elModeBtn.className = "btn-gray";
    elModeBtn.textContent = "AUTO";
  }
  elModeTxt.textContent = state.mode || "--";

  // Logic
  if (state.logic === "AC"){
    elLogicBtn.className = "btn-blue";
    elLogicBtn.textContent = "AC";
  } else {
    elLogicBtn.className = "btn-red";
    elLogicBtn.textContent = "HEAT";
  }

  // FEEDBACK status
  elKombiTxt.innerHTML = renderActStatus(state.kombi_online, state.kombi_act);
  elKlimaTxt.innerHTML = renderActStatus(state.klima_online, state.klima_act);

  const manual = (state.mode === "MANUAL");
  const mainOnline = (state.main_online === 1);

  const kOnline = mainOnline && !!state.kombi_online;
  const lOnline = mainOnline && !!state.klima_online;

  // only manual + online allows toggling
  elKombiBtn.disabled = !manual || !kOnline;
  elKlimaBtn.disabled = !manual || !lOnline;

  const kCmd = !!state.kombi_cmd;
  const lCmd = !!state.klima_cmd;

  const kPend = isPending(kOnline, state.kombi_act, state.kombi_cmd);
  const lPend = isPending(lOnline, state.klima_act, state.klima_cmd);

  if (!manual){
    elKombiBtn.className = "btn-gray";
    elKlimaBtn.className = "btn-gray";
    elKombiBtn.textContent = "KOMBI";
    elKlimaBtn.textContent = "KLIMA";
    return;
  }

  // KOMBI button
  if (!mainOnline){
    elKombiBtn.className = "btn-red";
    elKombiBtn.textContent = "ANA OFFLINE";
  } else if (!kOnline){
    elKombiBtn.className = "btn-red";
    elKombiBtn.textContent = "KOMBI OFFLINE";
  } else if (kPend){
    elKombiBtn.className = "btn-blue";
    elKombiBtn.textContent = (kCmd ? "KOMBI -> ON (Bekleniyor)" : "KOMBI -> OFF (Bekleniyor)");
  } else {
    const kAct = (state.kombi_act === 1);
    elKombiBtn.className = kAct ? "btn-green" : "btn-gray";
    elKombiBtn.textContent = kAct ? "KOMBI ON" : "KOMBI OFF";
  }

  // KLIMA button
  if (!mainOnline){
    elKlimaBtn.className = "btn-red";
    elKlimaBtn.textContent = "ANA OFFLINE";
  } else if (!lOnline){
    elKlimaBtn.className = "btn-red";
    elKlimaBtn.textContent = "KLIMA OFFLINE";
  } else if (lPend){
    elKlimaBtn.className = "btn-blue";
    elKlimaBtn.textContent = (lCmd ? "KLIMA -> ON (Bekleniyor)" : "KLIMA -> OFF (Bekleniyor)");
  } else {
    const lAct = (state.klima_act === 1);
    elKlimaBtn.className = lAct ? "btn-green" : "btn-gray";
    elKlimaBtn.textContent = lAct ? "KLIMA ON" : "KLIMA OFF";
  }
}

/* ===================== MQTT CMD ===================== */
function publishCmd(obj){
  if (!client || !client.connected) return;
  obj.key = CMD_KEY;
  client.publish(T_CMD, JSON.stringify(obj), {qos:0, retain:false});
}

function scheduleAutoSave(){
  if (debounceT) clearTimeout(debounceT);
  debounceT = setTimeout(()=>{
    const sp = parseFloat(elSP.value);
    const hys = parseFloat(elHys.value);
    if (Number.isNaN(sp) || Number.isNaN(hys)) return;
    publishCmd({ sp, hys });
    dirtySP=false; dirtyHys=false;
  }, 700);
}

elSP.addEventListener("input", ()=>{ dirtySP=true; scheduleAutoSave(); });
elHys.addEventListener("input", ()=>{ dirtyHys=true; scheduleAutoSave(); });

elSaveBtn.addEventListener("click", ()=>{
  const sp = parseFloat(elSP.value);
  const hys = parseFloat(elHys.value);
  if (Number.isNaN(sp) || Number.isNaN(hys)) return;
  publishCmd({ sp, hys });
  dirtySP=false; dirtyHys=false;
});

elModeBtn.addEventListener("click", ()=>{
  const next = (state.mode === "AUTO") ? "MANUAL" : "AUTO";
  publishCmd({ mode: next });
});

elLogicBtn.addEventListener("click", ()=>{
  const next = (state.logic === "AC") ? "HEAT" : "AC";
  publishCmd({ logic: next });
});

elKombiBtn.addEventListener("click", ()=>{
  if (!(state.main_online === 1) || !state.kombi_online) return;
  const next = state.kombi_cmd ? "OFF" : "ON";
  publishCmd({ kombi: next });
});

elKlimaBtn.addEventListener("click", ()=>{
  if (!(state.main_online === 1) || !state.klima_online) return;
  const next = state.klima_cmd ? "OFF" : "ON";
  publishCmd({ klima: next });
});

minmaxBtn.addEventListener("click", ()=>{
  publishCmd({ minmax: "RESET" });
});

/* ===================== MQTT START/STOP ===================== */
function mqttStart(){
  if (client) return;

  const clientId = "web_" + Math.random().toString(16).slice(2);
  client = mqtt.connect(BROKER_WSS, {
    clientId,
    clean: true,
    reconnectPeriod: 2000,
    connectTimeout: 8000,
    protocolVersion: 4
  });

  client.on("connect", ()=>{
    elConn.textContent = "BAÄLANDI";
    elConn.style.color = "#0a7a2f";
    elErr.textContent = "";
    client.subscribe([T_TELE, T_STATE, T_LWT], {qos:0});
  });

  client.on("reconnect", ()=>{
    elConn.textContent = "BaÄŸlanÄ±yorâ€¦";
    elConn.style.color = "#333";
  });

  client.on("offline", ()=>{
    elConn.textContent = "KAPALI";
    elConn.style.color = "#b00020";
    state.main_online = null;
    lastSeenMainMs = 0;
    markAllUnavailable();
    styleButtons();
  });

  client.on("error", (e)=>{
    elErr.textContent = "MQTT hata: " + (e?.message || e);
  });

  client.on("message", (topic, payload)=>{
    if (topic === T_LWT){
      const s = payload.toString().trim().toLowerCase();
      if (s === "online") {
        state.main_online = 1;
        lastSeenMainMs = Date.now();
      } else if (s === "offline") {
        state.main_online = 0;
        lastSeenMainMs = 0;
        markAllUnavailable();
      } else {
        state.main_online = null;
      }
      styleButtons();
      return;
    }

    // TELE/STATE => main canlÄ± demektir (heartbeat)
    lastSeenMainMs = Date.now();
    if (state.main_online !== 1) state.main_online = 1;

    let j=null;
    try { j = JSON.parse(payload.toString()); } catch(e){ return; }

    if (topic === T_TELE){
      elT.textContent = (j.t == null) ? "--" : (Number(j.t).toFixed(1) + " Â°C");
      elH.textContent = (j.h == null) ? "--" : (Number(j.h).toFixed(1) + " %");

      if (j.ts && j.tz_off_s != null){
        elLastSample.textContent = "Son okuma: " + fmtTRT(Number(j.ts), Number(j.tz_off_s));
      }
      elNTP.textContent = "NTP: " + (j.ntp_ok ? "OK" : "BEKLENÄ°YOR");

      if (j.mode)  state.mode = j.mode;
      if (j.logic) state.logic = j.logic;
      if (j.sp != null)  state.sp = Number(j.sp);
      if (j.hys != null) state.hys = Number(j.hys);

      if (j.kombi_cmd != null) state.kombi_cmd = clampInt(j.kombi_cmd, state.kombi_cmd);
      if (j.klima_cmd != null) state.klima_cmd = clampInt(j.klima_cmd, state.klima_cmd);

      if (j.kombi_online != null) state.kombi_online = clampInt(j.kombi_online, state.kombi_online);
      if (j.klima_online != null) state.klima_online = clampInt(j.klima_online, state.klima_online);

      if (j.kombi_act != null) state.kombi_act = clampInt(j.kombi_act, state.kombi_act);
      if (j.klima_act != null) state.klima_act = clampInt(j.klima_act, state.klima_act);

      if (!dirtySP && document.activeElement !== elSP) elSP.value = Number(j.sp ?? state.sp).toFixed(1);
      if (!dirtyHys && document.activeElement !== elHys) elHys.value = Number(j.hys ?? state.hys).toFixed(1);

      // Minmax
      const tmm = (j.tmin==null || j.tmax==null) ? "--" : `${Number(j.tmin).toFixed(1)} / ${Number(j.tmax).toFixed(1)} Â°C`;
      const hmm = (j.hmin==null || j.hmax==null) ? "--" : `${Number(j.hmin).toFixed(1)} / ${Number(j.hmax).toFixed(1)} %`;
      elTmm.textContent = tmm;
      elHmm.textContent = hmm;

      styleButtons();
    }

    if (topic === T_STATE){
      if (j.mode)  state.mode = j.mode;
      if (j.logic) state.logic = j.logic;
      if (j.sp != null)  state.sp = Number(j.sp);
      if (j.hys != null) state.hys = Number(j.hys);

      if (j.kombi_cmd != null) state.kombi_cmd = clampInt(j.kombi_cmd, state.kombi_cmd);
      if (j.klima_cmd != null) state.klima_cmd = clampInt(j.klima_cmd, state.klima_cmd);

      if (j.kombi_online != null) state.kombi_online = clampInt(j.kombi_online, state.kombi_online);
      if (j.klima_online != null) state.klima_online = clampInt(j.klima_online, state.klima_online);

      if (j.kombi_act != null) state.kombi_act = clampInt(j.kombi_act, state.kombi_act);
      if (j.klima_act != null) state.klima_act = clampInt(j.klima_act, state.klima_act);

      if (!dirtySP && document.activeElement !== elSP) elSP.value = state.sp.toFixed(1);
      if (!dirtyHys && document.activeElement !== elHys) elHys.value = state.hys.toFixed(1);

      // Minmax
      const tmm = (j.tmin==null || j.tmax==null) ? "--" : `${Number(j.tmin).toFixed(1)} / ${Number(j.tmax).toFixed(1)} Â°C`;
      const hmm = (j.hmin==null || j.hmax==null) ? "--" : `${Number(j.hmin).toFixed(1)} / ${Number(j.hmax).toFixed(1)} %`;
      elTmm.textContent = tmm;
      elHmm.textContent = hmm;

      styleButtons();
    }
  });
}

function mqttStop(){
  if (!client) return;
  try { client.end(true); } catch(e) {}
  client = null;
}

/* ===================== MAIN TTL WATCHDOG ===================== */
setInterval(()=>{
  if (state.main_online === 1 && lastSeenMainMs > 0){
    const dt = Date.now() - lastSeenMainMs;
    if (dt > MAIN_TTL_MS){
      state.main_online = 0;
      lastSeenMainMs = 0;
      markAllUnavailable();
      styleButtons();
    }
  }
}, 500);

/* ===================== LOGIN FLOW ===================== */
function showLogin(){
  panelView.classList.add("hidden");
  loginView.classList.remove("hidden");
  loginErr.textContent = "";
  mqttStop();
}

function showPanel(){
  loginView.classList.add("hidden");
  panelView.classList.remove("hidden");
  mqttStart();
  styleButtons();
}

function doLogin(){
  const u = (loginUser.value || "").trim();
  const p = (loginPass.value || "");
  if (u === LOGIN_USER && p === LOGIN_PASS){
    localStorage.setItem("hvac_auth", "1");
    showPanel();
  } else {
    loginErr.textContent = "HatalÄ± kullanÄ±cÄ± adÄ± veya ÅŸifre.";
  }
}

loginBtn.addEventListener("click", doLogin);
loginPass.addEventListener("keydown", (e)=>{ if (e.key === "Enter") doLogin(); });

loginClearBtn.addEventListener("click", ()=>{
  loginUser.value = "";
  loginPass.value = "";
  loginErr.textContent = "";
});

logoutBtn.addEventListener("click", ()=>{
  localStorage.removeItem("hvac_auth");
  showLogin();
});

if (localStorage.getItem("hvac_auth") === "1") showPanel();
else showLogin();
</script>

</body>
</html>
