<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HVAC Panel (MQTT)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 18px; background:#f1f1f1; }
    .wrap { max-width: 980px; }
    .top { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .card { padding: 14px; border: 2px solid #6b8e23; border-radius: 12px; background:#e6e6e6; }
    .row { display:flex; justify-content:space-between; align-items:center; gap:10px; padding:6px 0; }
    .val { font-weight: 800; }
    .muted { color:#555; font-size: .92rem; margin-top: 6px; }
    input { padding: 8px; border: 1px solid #bbb; border-radius: 10px; width: 160px; background:#fafafa; }
    button { padding: 10px 12px; border: 1px solid #bbb; border-radius: 10px; background: #f7f7f7; cursor: pointer; }
    button:active { transform: translateY(1px); }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .btnrow { display:flex; flex-wrap: wrap; gap: 10px; align-items:center; }
    .btn-green { background: #dcfce7; border-color:#86efac; }
    .btn-red   { background: #fee2e2; border-color:#fca5a5; }
    .btn-blue  { background: #dbeafe; border-color:#93c5fd; }
    .btn-gray  { background: #f3f4f6; border-color:#d1d5db; }

    /* Login */
    .center { min-height: calc(100vh - 36px); display:flex; align-items:center; justify-content:center; }
    .login { width: min(420px, 95vw); }
    .login h2 { margin: 0 0 10px 0; }
    .login .row { justify-content:flex-start; }
    .login label { display:flex; flex-direction:column; gap:6px; width: 100%; }
    .login input { width: 100%; }
    .login .actions { display:flex; gap:10px; margin-top:10px; }
    .hint { font-size:.9rem; color:#555; margin-top:8px; }
    .err { color:#b00020; font-weight:700; margin-top:8px; }

    @media (max-width: 900px){
      .top { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- ============ LOGIN VIEW ============ -->
<div id="loginView" class="center">
  <div class="wrap login">
    <div class="card">
      <h2>üîê Giri≈ü</h2>
      <div class="row" style="flex-direction:column; align-items:stretch;">
        <label>
          Kullanƒ±cƒ± adƒ±
          <input id="u" autocomplete="username" placeholder="kullanƒ±cƒ± adƒ±">
        </label>
        <label>
          ≈ûifre
          <input id="p" type="password" autocomplete="current-password" placeholder="≈üifre">
        </label>

        <div class="actions">
          <button id="loginBtn" class="btn-green" style="flex:1;">Giri≈ü</button>
          <button id="logoutBtn" class="btn-gray" style="flex:1; display:none;">√áƒ±kƒ±≈ü</button>
        </div>

        <div class="hint">
          Not: Bu giri≈ü sadece tarayƒ±cƒ± tarafƒ±nda ekran kilididir (ger√ßek g√ºvenlik deƒüildir).
        </div>
        <div id="loginErr" class="err"></div>
      </div>
    </div>
  </div>
</div>

<!-- ============ PANEL VIEW ============ -->
<div id="panelView" style="display:none;">
  <div class="wrap">
    <div class="top">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <h2 style="margin:0;">üì° √ñl√ß√ºmler</h2>
          <button id="exitBtn" class="btn-gray">√áƒ±kƒ±≈ü</button>
        </div>

        <div class="row"><div>Durum</div><div class="val" id="conn">Baƒülanƒ±yor‚Ä¶</div></div>
        <div class="row"><div>Sƒ±caklƒ±k</div><div class="val" id="t">--</div></div>
        <div class="row"><div>Nem</div><div class="val" id="h">--</div></div>

        <div class="row"><div>Min/Max (T)</div><div class="val" id="tmm">--</div></div>
        <div class="row"><div>Min/Max (H)</div><div class="val" id="hmm">--</div></div>

        <div class="muted" id="ts">Saat: --</div>
        <div class="muted" id="ntp">NTP: --</div>
        <div class="muted" id="err" style="color:#8a5a00;"></div>
      </div>

      <div class="card">
        <h2>üéõÔ∏è Kontrol</h2>
        <div class="row"><div>Mod</div><div class="val" id="modeTxt">--</div></div>
        <div class="row"><div>Kombi</div><div class="val" id="kombiTxt">--</div></div>
        <div class="row"><div>Klima</div><div class="val" id="klimaTxt">--</div></div>

        <div class="row">
          <div>Ayarlar</div>
          <div class="btnrow">
            <label>SP (¬∞C) <input id="sp" type="number" step="0.1" min="10" max="35"/></label>
            <label>Hys (¬∞C) <input id="hys" type="number" step="0.1" min="0.5" max="3.0"/></label>
            <button id="logicBtn" class="btn-blue">AC</button>
            <button id="saveBtn">Kaydet</button>
          </div>
        </div>

        <div class="btnrow" style="margin-top:8px;">
          <button id="modeBtn">AUTO</button>
          <button id="kombiBtn">KOMBI</button>
          <button id="klimaBtn">KLIMA</button>
        </div>

        <div class="muted" id="note">
          Not: MANUAL modda Kombi/Klima ayrƒ± ayrƒ± a√ßƒ±lƒ±r. AUTO modda logic‚Äôe g√∂re sadece biri √ßalƒ±≈üƒ±r.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- mqtt.js -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
/* =========================================================
   0) LOGIN AYARLARI (sen deƒüi≈ütir)
   ========================================================= */
const LOGIN_USER = "omer";       // <-- burayƒ± deƒüi≈ütir
const LOGIN_PASS = "1234";       // <-- burayƒ± deƒüi≈ütir

// Login "hatƒ±rla" (sayfa yenilense de a√ßƒ±k kalsƒ±n)
const AUTH_KEY = "hvac_auth_ok";

/* =========================================================
   1) MQTT AYARLARI (g√∂m√ºl√º)
   ========================================================= */
const BROKER_WSS = "wss://broker.emqx.io:8084/mqtt";
const BASE_TOPIC = "omer/hvac/9f3a1c7b2d4e6f8a";
const CMD_KEY    = "K!n@l1_2026_x9Qp7v";

const T_TELE  = `${BASE_TOPIC}/tele`;
const T_STATE = `${BASE_TOPIC}/state`;
const T_CMD   = `${BASE_TOPIC}/cmd`;
const T_LWT   = `${BASE_TOPIC}/lwt`;

/* =========================================================
   2) EKRAN GE√áƒ∞≈ûƒ∞ (login -> panel)
   ========================================================= */
const loginView = document.getElementById("loginView");
const panelView = document.getElementById("panelView");
const loginErr = document.getElementById("loginErr");

const u = document.getElementById("u");
const p = document.getElementById("p");
const loginBtn = document.getElementById("loginBtn");
const exitBtn  = document.getElementById("exitBtn");

function isAuthed(){
  return localStorage.getItem(AUTH_KEY) === "1";
}
function setAuthed(v){
  if (v) localStorage.setItem(AUTH_KEY, "1");
  else localStorage.removeItem(AUTH_KEY);
}

function showLogin(){
  panelView.style.display = "none";
  loginView.style.display = "flex";
  loginErr.textContent = "";
  // MQTT varsa kapat
  mqttStop();
}
function showPanel(){
  loginView.style.display = "none";
  panelView.style.display = "block";
  // MQTT ba≈ülat
  mqttStart();
}

function doLogin(){
  const user = (u.value || "").trim();
  const pass = (p.value || "");
  if (user === LOGIN_USER && pass === LOGIN_PASS){
    setAuthed(true);
    showPanel();
  } else {
    loginErr.textContent = "Hatalƒ± kullanƒ±cƒ± adƒ± veya ≈üifre.";
  }
}

loginBtn.addEventListener("click", doLogin);
p.addEventListener("keydown", (e)=>{ if (e.key === "Enter") doLogin(); });
u.addEventListener("keydown", (e)=>{ if (e.key === "Enter") doLogin(); });

exitBtn.addEventListener("click", ()=>{
  setAuthed(false);
  showLogin();
});

/* ƒ∞lk a√ßƒ±lƒ±≈ü */
if (isAuthed()) showPanel();
else showLogin();

/* =========================================================
   3) PANEL ELEMENTLERƒ∞
   ========================================================= */
const elConn = document.getElementById("conn");
const elT = document.getElementById("t");
const elH = document.getElementById("h");
const elTS = document.getElementById("ts");
const elNTP = document.getElementById("ntp");
const elErr = document.getElementById("err");
const elTmm = document.getElementById("tmm");
const elHmm = document.getElementById("hmm");

const elModeTxt = document.getElementById("modeTxt");
const elKombiTxt = document.getElementById("kombiTxt");
const elKlimaTxt = document.getElementById("klimaTxt");

const elSP = document.getElementById("sp");
const elHys = document.getElementById("hys");
const elLogicBtn = document.getElementById("logicBtn");
const elSaveBtn = document.getElementById("saveBtn");

const elModeBtn = document.getElementById("modeBtn");
const elKombiBtn = document.getElementById("kombiBtn");
const elKlimaBtn = document.getElementById("klimaBtn");

let state = {
  mode: null, logic: "AC",
  sp: 25.0, hys: 1.0,
  kombi: 0, klima: 0,
  tz_off_s: 0, ntp_ok: 0
};

/* Min/Max (oturum boyunca) */
let tMin = null, tMax = null, hMin = null, hMax = null;
function updMinMax(t, h){
  if (typeof t === "number" && Number.isFinite(t)){
    tMin = (tMin === null) ? t : Math.min(tMin, t);
    tMax = (tMax === null) ? t : Math.max(tMax, t);
    elTmm.textContent = `${tMin.toFixed(1)} / ${tMax.toFixed(1)} ¬∞C`;
  } else {
    if (tMin === null) elTmm.textContent = "--";
  }

  if (typeof h === "number" && Number.isFinite(h)){
    hMin = (hMin === null) ? h : Math.min(hMin, h);
    hMax = (hMax === null) ? h : Math.max(hMax, h);
    elHmm.textContent = `${hMin.toFixed(1)} / ${hMax.toFixed(1)} %`;
  } else {
    if (hMin === null) elHmm.textContent = "--";
  }
}

/* Normal saat (cihazƒ±n saatini g√∂ster) */
function pad2(n){ return (n<10 ? "0"+n : ""+n); }
function fmtLocalNow(){
  const d = new Date();
  return pad2(d.getDate())+"/"+pad2(d.getMonth()+1)+"/"+d.getFullYear()+" "+
         pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds());
}
let clockT = null;
function startClock(){
  if (clockT) return;
  elTS.textContent = "Saat: " + fmtLocalNow();
  clockT = setInterval(()=>{ elTS.textContent = "Saat: " + fmtLocalNow(); }, 1000);
}
function stopClock(){
  if (clockT){ clearInterval(clockT); clockT=null; }
}

let dirtySP=false, dirtyHys=false;
let debounceT=null;

function styleButtons(){
  if (state.mode === "AUTO"){
    elModeBtn.className = "btn-green";
    elModeBtn.textContent = "AUTO";
  } else if (state.mode === "MANUAL"){
    elModeBtn.className = "btn-red";
    elModeBtn.textContent = "MANUAL";
  } else {
    elModeBtn.className = "btn-gray";
    elModeBtn.textContent = "AUTO";
  }
  elModeTxt.textContent = state.mode || "--";

  if (state.logic === "AC"){
    elLogicBtn.className = "btn-blue";
    elLogicBtn.textContent = "AC";
  } else {
    elLogicBtn.className = "btn-red";
    elLogicBtn.textContent = "HEAT";
  }

  elKombiTxt.textContent = state.kombi ? "ON" : "OFF";
  elKlimaTxt.textContent = state.klima ? "ON" : "OFF";

  const manual = (state.mode === "MANUAL");
  elKombiBtn.disabled = !manual;
  elKlimaBtn.disabled = !manual;

  elKombiBtn.className = manual ? (state.kombi ? "btn-green":"btn-gray") : "btn-gray";
  elKlimaBtn.className = manual ? (state.klima ? "btn-green":"btn-gray") : "btn-gray";

  elKombiBtn.textContent = manual ? (state.kombi ? "KOMBI ON":"KOMBI OFF") : "KOMBI";
  elKlimaBtn.textContent = manual ? (state.klima ? "KLIMA ON":"KLIMA OFF") : "KLIMA";
}

/* =========================================================
   4) MQTT START/STOP (login sonrasƒ± ba≈ülasƒ±n)
   ========================================================= */
let client = null;

function publishCmd(obj){
  if (!client || !client.connected) return;
  obj.key = CMD_KEY;
  client.publish(T_CMD, JSON.stringify(obj), {qos:0, retain:false});
}

function scheduleAutoSave(){
  if (debounceT) clearTimeout(debounceT);
  debounceT = setTimeout(()=>{
    const sp = parseFloat(elSP.value);
    const hys = parseFloat(elHys.value);
    if (Number.isNaN(sp) || Number.isNaN(hys)) return;
    publishCmd({ sp, hys });
    dirtySP=false; dirtyHys=false;
  }, 2000);
}

elSP.addEventListener("input", ()=>{ dirtySP=true; scheduleAutoSave(); });
elHys.addEventListener("input", ()=>{ dirtyHys=true; scheduleAutoSave(); });

elSaveBtn.addEventListener("click", ()=>{
  const sp = parseFloat(elSP.value);
  const hys = parseFloat(elHys.value);
  if (Number.isNaN(sp) || Number.isNaN(hys)) return;
  publishCmd({ sp, hys });
  dirtySP=false; dirtyHys=false;
});

elModeBtn.addEventListener("click", ()=>{
  const next = (state.mode === "AUTO") ? "MANUAL" : "AUTO";
  publishCmd({ mode: next });
});

elLogicBtn.addEventListener("click", ()=>{
  const next = (state.logic === "AC") ? "HEAT" : "AC";
  publishCmd({ logic: next });
});

elKombiBtn.addEventListener("click", ()=>{
  const next = state.kombi ? "OFF" : "ON";
  publishCmd({ kombi: next });
});

elKlimaBtn.addEventListener("click", ()=>{
  const next = state.klima ? "OFF" : "ON";
  publishCmd({ klima: next });
});

function mqttStart(){
  if (client) return; // zaten √ßalƒ±≈üƒ±yor
  startClock();

  // UI reset
  elConn.textContent = "Baƒülanƒ±yor‚Ä¶";
  elConn.style.color = "#333";
  elErr.textContent = "";

  const clientId = "web_" + Math.random().toString(16).slice(2);

  client = mqtt.connect(BROKER_WSS, {
    clientId,
    clean: true,
    reconnectPeriod: 2000,
    connectTimeout: 8000,
    protocolVersion: 4
  });

  client.on("connect", ()=>{
    elConn.textContent = "BAƒûLANDI";
    elConn.style.color = "#0a7a2f";
    elErr.textContent = "";
    client.subscribe([T_TELE, T_STATE, T_LWT], {qos:0});
  });

  client.on("reconnect", ()=>{
    elConn.textContent = "Baƒülanƒ±yor‚Ä¶";
    elConn.style.color = "#333";
  });

  client.on("offline", ()=>{
    elConn.textContent = "KAPALI";
    elConn.style.color = "#b00020";
  });

  client.on("error", (e)=>{
    elErr.textContent = "MQTT hata: " + (e?.message || e);
  });

  client.on("message", (topic, payload)=>{
    let j=null;
    try { j = JSON.parse(payload.toString()); } catch(e){ return; }

    if (topic === T_LWT){
      return; // sadece bilgi
    }

    if (topic === T_TELE){
      const t = (j.t == null) ? null : Number(j.t);
      const h = (j.h == null) ? null : Number(j.h);

      if (t == null || !Number.isFinite(t)) elT.textContent = "--";
      else elT.textContent = t.toFixed(1) + " ¬∞C";

      if (h == null || !Number.isFinite(h)) elH.textContent = "--";
      else elH.textContent = h.toFixed(1) + " %";

      updMinMax(t, h);

      // NTP g√∂stergesi (ESP'den gelen)
      elNTP.textContent = "NTP: " + (j.ntp_ok ? "OK" : "BEKLENƒ∞YOR");

      // state alanlarƒ± (tele i√ßine de geliyor)
      if (j.mode)  state.mode = j.mode;
      if (j.logic) state.logic = j.logic;
      if (j.sp != null)  state.sp = Number(j.sp);
      if (j.hys != null) state.hys = Number(j.hys);
      if (j.kombi != null) state.kombi = Number(j.kombi);
      if (j.klima != null) state.klima = Number(j.klima);
      if (j.tz_off_s != null) state.tz_off_s = Number(j.tz_off_s);
      if (j.ntp_ok != null) state.ntp_ok = Number(j.ntp_ok);

      if (!dirtySP && document.activeElement !== elSP) elSP.value = state.sp.toFixed(1);
      if (!dirtyHys && document.activeElement !== elHys) elHys.value = state.hys.toFixed(1);

      styleButtons();
    }

    if (topic === T_STATE){
      if (j.mode)  state.mode = j.mode;
      if (j.logic) state.logic = j.logic;
      if (j.sp != null)  state.sp = Number(j.sp);
      if (j.hys != null) state.hys = Number(j.hys);

      if (j.kombi) state.kombi = (j.kombi === "ON") ? 1 : 0;
      if (j.klima) state.klima = (j.klima === "ON") ? 1 : 0;

      if (!dirtySP && document.activeElement !== elSP) elSP.value = state.sp.toFixed(1);
      if (!dirtyHys && document.activeElement !== elHys) elHys.value = state.hys.toFixed(1);

      styleButtons();
    }
  });
}

function mqttStop(){
  stopClock();
  if (!client) return;
  try { client.end(true); } catch(e){}
  client = null;

  // baƒülantƒ± yazƒ±sƒ±
  elConn.textContent = "KAPALI";
  elConn.style.color = "#b00020";
}
</script>
</body>
</html>
